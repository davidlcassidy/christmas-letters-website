<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ„</text></svg>">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Homemade+Apple&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
		:root {
		  --background-header: #196719;
		  --background-main: #D6F5D6;
		  --background-card: white;
		  --background-button: #196719;
		  --background-slider: #DA3E3E;
		  --border-card: #145214;
		  --hover-button: #239023;
		  --text-primary: #006400;
		  --text-secondary: #DA3E3E;
		  --text-button: white;
		  --box-shadow-light: rgba(0, 0, 0, 0.08);
		  --box-shadow-strong: rgba(0, 0, 0, 0.15);
		}
		
		* {
		  box-sizing: border-box;
		}
		
		header {
			background: var(--background-header);
			color: var(--background-main);
			padding: 20px;
			text-align: center;
			position: sticky;
			top: 0;
			z-index: 1000;
			width: 100%;
			border-bottom: 2px solid var(--background-main);
		}

		body {
		  font-family: 'Twemoji Country Flags', 'Arial', sans-serif;
		  margin: 0;
		  padding: 0;
		  background: var(--background-main);
		  color: var(--text-primary);
		  line-height: 1.6;
		}

		h1 {
		  font-size: 36px;
		  margin: 0;
		  font-family: 'Georgia', serif;
		}
		  
		h2 {
		  text-align: center;
		  color: var(--text-primary);
		  font-size: 28px;
		  font-family: 'Georgia', serif;
		  margin: 0 0 30px 0;
		  padding: 0; 
		}

		p {
		  text-align: left;
		  color: var(--text-primary);
		  font-size: 20px;
		  margin: 25px 0;
		}
	  
		a {
		  display: flex;
		  align-items: center;
		  justify-content: center;
	      text-align: center;
		  padding: 3px 0px;
		  margin: 5px;
		  font-size: 20px;
		  min-height: 62px;
		  color: var(--text-button);
		  background: var(--background-button);
		  border-radius: 8px;
		  text-decoration: none;
		  gap: 10px
		}

		a:hover {
		  background: var(--hover-button);
		}
	  
		hr {
		  border: none;
		  height: 2px;
		  background: var(--background-header);
		  width: 75%;
          margin: 50px auto 0px auto;
		  border-radius: 5px;
		}

		#language-toggle {
		  display: none;
		  position: absolute;
		  right: 25px;
		  top: 50%;
		  transform: translateY(-50%);
		  align-items: center;
		  gap: 15px;
		}

		.switch {
		  position: relative;
		  display: inline-block;
		  width: 50px;
		  height: 28px;
		}

		.switch input {
		  opacity: 0;
		  width: 0;
		  height: 0;
		}

		.slider {
		  position: absolute;
		  cursor: pointer;
		  top: 0;
		  left: 0;
		  right: 0;
		  bottom: 0;
		  background-color: var(--background-slider);
		  border-radius: 28px;
		  transition: 0.4s;
		}

		.slider:before {
		  position: absolute;
		  content: "";
		  height: 20px;
		  width: 20px;
		  left: 4px;
		  bottom: 4px;
		  background-color: var(--text-button);
		  border-radius: 50%;
		  transition: 0.4s;
		}

		input:checked + .slider:before {
		  transform: translateX(22px);
		}

		.flag {
		  font-size: 45px;
		}

	  .card {
		width: 95%;
		max-width: 1000px;
		margin: 40px auto;
		padding: 50px 30px;
		background: var(--background-card);
		border-radius: 15px;
		box-shadow: 0px 4px 10px var(--box-shadow-strong);
		border: 3px solid var(--border-card);
		position: relative;
		overflow: hidden;
	  }
	  
	  #tree-container {
		font-size: 40px;
		letter-spacing: 14px;
	  }
	  
	  #current-intro {
		text-align: center;
	  }
	  
	  #current-letters-buttons {
		margin-top: 30px;
		margin-bottom: 5px;
	  }
	  
	  .flag-emoji {
		font-size: 35px;
	  }

	  #current-letters-card a {
		width: 230px;
	  }
	  
	  #archive-header {
		cursor: pointer;
		margin-bottom:0px;
	  }
	  
	  #archive-content {
		display:none;
		margin-top:30px
	  }
	  
	  #archive-signature {
		font-family: 'Homemade Apple', cursive;
		font-size: 24px;
		font-weight: bold;
		color: var(--text-primary);
	  }
	  
	  #archive-toggle {
		background: none;
		color: var(--text-primary);
		font-size: 30px;
		cursor: pointer;
		position: absolute;
		top: 55px;
		right: 10px;
		border: none;
	  }

	  .button-container {
		display: flex;
		flex-wrap: wrap;
		gap: 20px;
		justify-content: center;
	  }

	  table {
		width: 100%;
		border: 2px solid var(--border-table);
		overflow-x: auto;
		margin-top: 25px;
	  }

	  table td {
		padding: 25px;
		text-align: center;
		border-bottom: 2px solid var(--border-table);
		word-wrap: break-word;
	  }
	  
	  table tr:last-child td {
		  border-bottom: none;
		}

	  table td.year {
		font-size: 25px;
		font-weight: bold;
		color: var(--text-secondary);
	  }

	  table .button-container {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 10px;
	  }
	  
	  @media (max-width: 768px) {
		h1 {
		  font-size: 29px;
		}
		
		h2 {
		  font-size: 22px;
		}
		
		p {
		  font-size: 16px;
	    }
		
		hr {
		  margin-top: 40px;
		}
		
		a {
		  font-size: 18px;
	    }
		
		header {
		  position: relative;
		}
		
		.card {
		  padding: 25px 20px;
		}
		
		#tree-container {
		  font-size: 30px;
		}
		
		#current-letters-card a {
		  width: 80%;
		}

		.button-container a {
		  font-size: 20px;
		}
		
		#archive-header {
		  margin-right: 20px;
		}
		
		#archive-toggle {
			top: 20px;
			right: 5px;
		}
		
		#archive-signature {
		  font-size: 20px;
		}
		
		.flag-emoji {
		  font-size: 32px;
	    }
		
		table td {
		  padding-right: 5px;
		}
		
		table td.year {
		  padding: 0px;
		  transform: rotate(-90deg) translateY(-10px);
		}
		
		table .button-container {
		  grid-template-columns: repeat(1, 1fr);
		  gap: 13px;
		  padding-left: 0px;
		}
	</style>

</head>

<body>
  <header>
    <h1 id="header"></h1>
    <div id="language-toggle">
	  <span id="flag-1" class="flag"></span>
	  <label class="switch">
		<input id="language-switch" type="checkbox" onchange="translatePage(); generateButtons();"><span class="slider"></span>
	  </label>
	  <span id="flag-2" class="flag"></span>
	</div>
  </header>

  <div id="current-letters-card" class="card">
    <h2 id="tree-container"></h2>
	<h2 id="current-greating"></h2>
	<p id="current-intro"></p>
    <div id="current-letters-buttons" class="button-container"></div>
  </div>

  <div id="archive-letters-card" class="card">
    <button id="archive-toggle" onclick="toggleArchiveVisibility()">â–¼</button>
    <h2 id="archive-header" onclick="toggleArchiveVisibility()"></h2>
    <div id="archive-content">
	  <p id="archive-description"></p>
	  <p id="archive-signature"></p>
	  <hr id="archive-divider">
	  <table>
		<tbody id="archive-table-body"></tbody>
	  </table>
	</div>
  </div>
  
  <!-- Fix to get the country flags to show in Chromium browsers -->
  <script type="module" defer>
    import { polyfillCountryFlagEmojis } from "https://cdn.skypack.dev/country-flag-emoji-polyfill";
    polyfillCountryFlagEmojis();
  </script>

  <script>
  
	let localizationConfig = null;
    let letterConfig = null;
	
	function setToggleLanguages() {
	  try {
		const enabledLanguages = localizationConfig.enabledLanguages.split(',').map(lang => lang.trim()).slice(0, 2);
		if (enabledLanguages.length == 2 && isDesktopView()) {
		  document.getElementById('flag-1').textContent = getFlagEmoji(enabledLanguages[0]);
		  document.getElementById('flag-2').textContent = getFlagEmoji(enabledLanguages[1]);
		  document.getElementById('language-toggle').style.display = 'flex';
		}
		document.getElementById('language-switch').checked = (navigator.language || navigator.userLanguage).startsWith(enabledLanguages[1]);
	  } catch (error) {
		console.error('Error populating available languages:', error);
	  }
	}
	
	function translatePage() {
	  const enabledLanguages = localizationConfig.enabledLanguages.split(',').map(lang => lang.trim()).slice(0, 2);

	  if (enabledLanguages.length === 0) {
		console.error('No enabled languages provide.');
		return;
	  }

	  const selectedLanguage = isSecondLanguageSelected() ? enabledLanguages[1] : enabledLanguages[0];

	  const placeholders = localizationConfig.placeholders || {};
	  const translations = localizationConfig.translations[selectedLanguage];

	  if (!translations) {
		console.error(`Translations for language '${selectedLanguage}' not found.`);
		return;
	  }

	  document.documentElement.setAttribute('lang', selectedLanguage);
	  document.title = replacePlaceholders(translations.mainPageTitle, placeholders);

	  const elementsToTranslate = {
		header: document.getElementById('header'),
		currentGreeting: document.getElementById('current-greating'),
		currentIntro: document.getElementById('current-intro'),
		archiveHeader: document.getElementById('archive-header'),
		archiveDescription: document.getElementById('archive-description'),
		archiveSignature: document.getElementById('archive-signature'),
	  };

	  Object.keys(elementsToTranslate).forEach((key) => {
		if (elementsToTranslate[key]) {
		  const shortKey = `${key}Short`;
		  const text = isMobileView() && translations[shortKey] ? translations[shortKey] : translations[key];
		  elementsToTranslate[key].textContent = replacePlaceholders(text, placeholders);
		}
	  });
	}
	
	function generateButtons() {
	  try {
		const letterYears = Object.keys(letterConfig).map(year => parseInt(year));
		const currentYear = Math.max(...letterYears);

		// Generate buttons for the current year
		const currentLettersButtons = document.getElementById('current-letters-buttons');
		currentLettersButtons.innerHTML = "";
		createButtons(letterConfig[currentYear], currentLettersButtons);

		// Generate archive table rows for the previous years
		const archiveTableBody = document.getElementById('archive-table-body');
		archiveTableBody.innerHTML = "";
		letterYears
		  .filter(year => year !== currentYear)
		  .sort((a, b) => b - a) // Sort years in descending order
		  .forEach(year => {
			const tr = document.createElement('tr');
			const tdYear = document.createElement('td');
			tdYear.classList.add('year');
			tdYear.textContent = year;

			const tdLinks = document.createElement('td');
			tdLinks.classList.add('button-container');
			createButtons(letterConfig[year], tdLinks);

			tr.appendChild(tdYear);
			tr.appendChild(tdLinks);
			archiveTableBody.appendChild(tr);
		  });
	  } catch (error) {
		console.error('Error generating buttons:', error);
	  }
	}

	function toggleArchiveVisibility() {
	  const archiveContent = document.getElementById('archive-content');
	  const toggleArchiveBtn = document.getElementById('archive-toggle');
	  archiveContent.style.display = archiveContent.style.display === 'block' ? 'none' : 'block';
	  toggleArchiveBtn.textContent = toggleArchiveBtn.textContent === 'â–¼' ? 'â–²' : 'â–¼';
	}
	
	// Helper function to create buttons
	function createButtons(buttons, container) {
	  const orderedButtons = isSecondLanguageSelected() ? buttons.slice().reverse() : buttons;
	  container.innerHTML = ""; // Clear container
	  orderedButtons.forEach(button => {
		const aTag = document.createElement('a');
		const flagSpan = document.createElement('span');
		flagSpan.classList.add('flag-emoji');
		flagSpan.textContent = button.language && getFlagEmoji(button.language);

		aTag.href = button.pdfSrc;
		aTag.target = "_blank";
		aTag.textContent = button.title || "";
		aTag.appendChild(flagSpan);

		container.appendChild(aTag);
	  });
	}
	
	// Helper function to provide the flag emoji corresponding to a language code
	function getFlagEmoji(languageCode) {
	  const countryCodeOverrides = {
		'en': 'gb',
		'pt': 'br',
		'zh': 'cn',
		'ar': 'sa',
		'hi': 'in',
	  };
	  const countryCode = countryCodeOverrides[languageCode] || languageCode;
	  const codePoints = countryCode.toUpperCase().split('').map(c => 0x1F1E6 - 65 + c.charCodeAt(0));
	  return String.fromCodePoint(...codePoints);
	}

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
		try {
			// Load config files
			const localizationConfigResponse = await fetch('configs/localization.json');
			const letterConfigResponse = await fetch('configs/christmas_letters.json');
			localizationConfig = await localizationConfigResponse.json();
			letterConfig = await letterConfigResponse.json();
			
			document.getElementById('tree-container').innerHTML = 'ðŸŽ„'.repeat(isMobileView() ? 4 : 7);
			setToggleLanguages();
			translatePage();
			generateButtons();
		} catch (error) {
			console.error('Error loading configuration files:', error);
		}
	});
	
	const isDesktopView = () => window.innerWidth >= 1200;
    const isMobileView = () => window.innerWidth <= 768;
	const replacePlaceholders = (text, placeholders) => text.replace(/{{(.*?)}}/g, (_, key) => placeholders[key.trim()] || '');
	const isSecondLanguageSelected = () => document.getElementById('language-switch').checked;
  </script>

</body>

</html>
